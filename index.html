<!DOCTYPE html>
<html>
<head>
  <title>My Recorder ‚Äì Google Drive Upload</title>
  <style>
    body            { font-family: Arial, sans-serif; margin: 2rem; }
    button, select  { margin:.25rem 0; }
    video           { width:80%; margin-top:1rem; display:none; }
    ul              { list-style:none; padding-left:0; }
    li              { margin:.25rem 0; }
    #folderHint     { color:red; }
    #status         { margin-top:1rem; font-weight:bold; }
  </style>
</head>
<body>
  <h2>My Recorder</h2>

  <!-- ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ -->
  <button onclick="authenticate()">üîê Login mit Google</button>
  <span id="authStatus"></span>

  <!-- ‚îÄ‚îÄ‚îÄ ORDNER ‚îÄ‚îÄ‚îÄ -->
  <h3>Aufnahme-Ordner w√§hlen</h3>
  <select id="folderSelect"></select>
  <button onclick="populateFolders()">üîÑ Ordner neu laden</button>
  <button onclick="createFolder()">‚ûï Neuen Ordner anlegen</button>
  <p id="folderHint"></p>

  <!-- ‚îÄ‚îÄ‚îÄ DATEIEN (aufklappbar) ‚îÄ‚îÄ‚îÄ -->
  <details id="fileSection">
    <summary id="fileSummary">Aufzeichnungen im Ordner</summary>
    <ul id="fileList"></ul>
  </details>

  <!-- ‚îÄ‚îÄ‚îÄ AUFNAHME ‚îÄ‚îÄ‚îÄ -->
  <h3>Aufnahme</h3>
  <button onclick="startRecording()">‚è∫Ô∏è Start Recording</button>
  <button onclick="stopRecording()" disabled>‚èπÔ∏è Stop Recording</button>
  <video id="preview" controls muted playsinline></video>

  <!-- ‚îÄ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ‚îÄ -->
  <div id="status"></div>

<script>
/* CONFIG */
const CLIENT_ID    = "532950765171-rfh9ide8056k8sstf06qhcm96iv92s22.apps.googleusercontent.com";
const REDIRECT_URI = "https://my-recorder.vercel.app";
const SCOPE        = "https://www.googleapis.com/auth/drive";

/* GLOBALS */
let accessToken=null, mediaRecorder=null, recordedChunks=[], currentStream=null;

/* ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ */
function authenticate(){
  const url="https://accounts.google.com/o/oauth2/v2/auth?" +
     "client_id="+CLIENT_ID +
     "&redirect_uri="+encodeURIComponent(REDIRECT_URI) +
     "&response_type=token" +
     "&scope="+encodeURIComponent(SCOPE) +
     "&prompt=consent";
  location.href=url;
}
window.onload=()=>{
  const p=new URLSearchParams(location.hash.slice(1));
  if(p.has("access_token")){
    accessToken=p.get("access_token");
    document.getElementById("authStatus").textContent="‚úÖ eingeloggt";
    populateFolders();
  }
};

/* ‚îÄ‚îÄ‚îÄ ORDNER ‚îÄ‚îÄ‚îÄ */
async function populateFolders(){
  if(!accessToken) return;
  const sel=document.getElementById("folderSelect"); sel.innerHTML="";
  document.getElementById("folderHint").textContent="";
  const q="mimeType='application/vnd.google-apps.folder' and trashed=false";
  const res=await gapi("https://www.googleapis.com/drive/v3/files?fields=files(id,name)&orderBy=name&q="+encodeURIComponent(q));
  if(res.error){ document.getElementById("folderHint").textContent="‚ùå "+res.error.message; return;}
  if(!res.files.length){ document.getElementById("folderHint").textContent="‚ö†Ô∏è Keine Ordner gefunden."; return;}
  res.files.forEach(f=>{ const o=document.createElement("option"); o.value=f.id; o.textContent=f.name; sel.appendChild(o); });
  loadFolderFiles();
}
async function createFolder(){
  if(!accessToken) return alert("Bitte einloggen.");
  const name=prompt("Ordnername?"); if(!name) return;
  await fetch("https://www.googleapis.com/drive/v3/files",{method:"POST",headers:{Authorization:"Bearer "+accessToken,"Content-Type":"application/json"},body:JSON.stringify({name,mimeType:"application/vnd.google-apps.folder"})});
  populateFolders();
}

/* ‚îÄ‚îÄ‚îÄ DATEIEN LISTEN ‚îÄ‚îÄ‚îÄ */
async function loadFolderFiles(){
  const folderId=document.getElementById("folderSelect").value;
  if(!folderId) return;
  const q=`'${folderId}' in parents and trashed=false and (mimeType contains 'video/' or name contains '.webm')`;
  const res=await gapi("https://www.googleapis.com/drive/v3/files?fields=files(id,name,modifiedTime)&orderBy=modifiedTime desc&q="+encodeURIComponent(q));
  const ul=document.getElementById("fileList"); ul.innerHTML="";
  res.files.forEach(f=>{
    const li=document.createElement("li");
    const a=document.createElement("a");
    a.href=`https://drive.google.com/file/d/${f.id}/view`; a.target="_blank";
    a.textContent=`${new Date(f.modifiedTime).toLocaleString()} ‚Äì ${f.name}`;
    li.appendChild(a); ul.appendChild(li);
  });
  document.getElementById("fileSummary").textContent=`Aufzeichnungen im Ordner (${res.files.length})`;
}

/* ‚îÄ‚îÄ‚îÄ AUFNAHME ‚îÄ‚îÄ‚îÄ */
async function startRecording(){
  try{
    currentStream=await navigator.mediaDevices.getDisplayMedia({video:true,audio:true});
    const vid=document.getElementById("preview");
    vid.srcObject=currentStream; vid.style.display="block"; await vid.play();
    recordedChunks=[]; mediaRecorder=new MediaRecorder(currentStream);
    mediaRecorder.ondataavailable=e=>e.data.size&&recordedChunks.push(e.data);
    mediaRecorder.onstop=handleStop; mediaRecorder.start();
    currentStream.getVideoTracks()[0].onended=stopRecording;
    toggleRecButtons(true);
  }catch(e){ alert("Freigabe fehlgeschlagen: "+e); }
}
function stopRecording(){
  if(mediaRecorder && mediaRecorder.state!=="inactive") mediaRecorder.stop();
  if(currentStream) currentStream.getTracks().forEach(t=>t.stop());
  toggleRecButtons(false);
}
async function handleStop(){
  const blob=new Blob(recordedChunks,{type:"video/webm"});
  const vid=document.getElementById("preview");
  vid.srcObject=null; vid.src=URL.createObjectURL(blob);

  /* ‚îÄ‚îÄ Neuer Dateiname ‚îÄ‚îÄ */
  const custom=prompt("Dateiname (optional):");
  const finalName = custom && custom.trim() ? custom.trim().replace(/\.webm$/i,"") + ".webm"
                                            : "Recording_"+new Date().toISOString()+".webm";

  await uploadToDrive(blob, finalName);
}
function toggleRecButtons(r){
  document.querySelector("button[onclick='startRecording()']").disabled=r;
  document.querySelector("button[onclick='stopRecording()']").disabled =!r;
}

/* ‚îÄ‚îÄ‚îÄ UPLOAD ‚îÄ‚îÄ‚îÄ */
async function uploadToDrive(blob,fileName){
  if(!accessToken) return alert("Bitte einloggen!");
  const folderId=document.getElementById("folderSelect").value;
  const meta={name:fileName,mimeType:"video/webm",parents:[folderId]};
  const form=new FormData();
  form.append("metadata",new Blob([JSON.stringify(meta)],{type:"application/json"}));
  form.append("file",blob);

  setStatus("‚è≥ Upload l√§uft ‚Ä¶");
  const up=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:{Authorization:"Bearer "+accessToken},body:form});
  const file=await up.json();
  await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}/permissions`,{method:"POST",headers:{Authorization:"Bearer "+accessToken,"Content-Type":"application/json"},body:JSON.stringify({role:"reader",type:"anyone"})});
  const link=`https://drive.google.com/file/d/${file.id}/view`;
  setStatus(`‚úÖ Hochgeladen: <a href="${link}" target="_blank">${link}</a>`);
  loadFolderFiles();
}
function setStatus(html){ document.getElementById("status").innerHTML=html; }

/* ‚îÄ‚îÄ‚îÄ HELPER ‚îÄ‚îÄ‚îÄ */
async function gapi(url){ const r=await fetch(url,{headers:{Authorization:"Bearer "+accessToken}}); return r.json(); }
</script>
</body>
</html>
