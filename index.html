<!DOCTYPE html>
<html>
<head>
  <title>My Recorder ‚Äì Upload to Google Drive</title>
</head>
<body>
  <h2>My Recorder</h2>

  <button onclick="authenticate()">üîê Login with Google</button><br><br>

  <button onclick="startRecording()">‚è∫Ô∏è Start Recording</button>
  <button onclick="stopRecording()" disabled>‚èπÔ∏è Stop Recording</button><br><br>

  <video id="preview" controls autoplay muted style="width:80%; display:none;"></video><br><br>

  <pre id="output"></pre>

  <script>
    let accessToken = null;
    let mediaRecorder;
    let recordedChunks = [];

    function authenticate() {
      const authUrl = "https://accounts.google.com/o/oauth2/v2/auth?" +
        "client_id=532950765171-rfh9ide8056k8sstf06qhcm96iv92s22.apps.googleusercontent.com&" +
        "redirect_uri=https://my-recorder.vercel.app&" +
        "response_type=token&" +
        "scope=https://www.googleapis.com/auth/drive.file&" +
        "prompt=consent";
      window.location = authUrl;
    }

    window.onload = function() {
      const hash = window.location.hash.substr(1);
      const params = new URLSearchParams(hash);
      if (params.has("access_token")) {
        accessToken = params.get("access_token");
        document.getElementById("output").textContent = "‚úÖ Access token acquired!";
      }
    }

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({
          video: true,
          audio: true
        });
        document.getElementById("preview").srcObject = stream;
        document.getElementById("preview").style.display = "block";

        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = function(e) {
          if (e.data.size > 0) {
            recordedChunks.push(e.data);
          }
        };

        mediaRecorder.onstop = function() {
          const blob = new Blob(recordedChunks, { type: "video/webm" });
          uploadToDrive(blob);
        };

        mediaRecorder.start();
        document.querySelector("button[onclick='startRecording()']").disabled = true;
        document.querySelector("button[onclick='stopRecording()']").disabled = false;
      } catch (err) {
        alert("Fehler bei der Bildschirmfreigabe: " + err);
      }
    }

    function stopRecording() {
      mediaRecorder.stop();
      document.querySelector("button[onclick='startRecording()']").disabled = false;
      document.querySelector("button[onclick='stopRecording()']").disabled = true;
    }

    async function uploadToDrive(blob) {
      if (!accessToken) {
        alert("Bitte zuerst einloggen.");
        return;
      }

      const metadata = {
        name: "Recording_" + new Date().toISOString() + ".webm",
        mimeType: "video/webm"
      };

      const form = new FormData();
      form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
      form.append("file", blob);

      const uploadRes = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
        method: "POST",
        headers: {
          Authorization: "Bearer " + accessToken
        },
        body: form
      });

      const uploadData = await uploadRes.json();

      // Set permission: anyoneWithLink can view
      await fetch("https://www.googleapis.com/drive/v3/files/" + uploadData.id + "/permissions", {
        method: "POST",
        headers: {
          Authorization: "Bearer " + accessToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          role: "reader",
          type: "anyone"
        })
      });

      const viewLink = "https://drive.google.com/file/d/" + uploadData.id + "/view";
      document.getElementById("output").innerHTML =
        "‚úÖ Hochgeladen!\nüìé <a href='" + viewLink + "' target='_blank'>" + viewLink + "</a>";
    }
  </script>
</body>
</html>
