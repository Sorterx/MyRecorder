<!DOCTYPE html>
<html>
<head>
  <title>My Recorder â€“ Google Drive Upload</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    button, select { margin:.25rem 0; }
    video { width:80%; margin-top:1rem; display:none; }
    ul { list-style:none; padding-left:0; }
    li { margin:.25rem 0; }
    #folderHint { color:red; }
  </style>
</head>
<body>
  <h2>My Recorder</h2>

  <!-- â”€â”€â”€ AUTH â”€â”€â”€ -->
  <button onclick="authenticate()">ğŸ” Login mit Google</button>
  <span id="authStatus"></span>

  <!-- â”€â”€â”€ ORDNER â”€â”€â”€ -->
  <h3>Aufnahme-Ordner wÃ¤hlen</h3>
  <select id="folderSelect"></select>
  <button onclick="populateFolders()">ğŸ”„ Ordner neu laden</button>
  <button onclick="createFolder()">â• Neuen Ordner anlegen</button>
  <p id="folderHint"></p>

  <!-- â”€â”€â”€ DATEIEN â”€â”€â”€ -->
  <h3>Aufzeichnungen im Ordner</h3>
  <ul id="fileList"></ul>

  <!-- â”€â”€â”€ AUFNAHME â”€â”€â”€ -->
  <h3>Aufnahme</h3>
  <button onclick="startRecording()">âºï¸ Start Recording</button>
  <button onclick="stopRecording()" disabled>â¹ï¸ Stop Recording</button>
  <video id="preview" controls muted></video>

  <!-- â”€â”€â”€ STATUS â”€â”€â”€ -->
  <pre id="output"></pre>

<script>
/* CONFIG */
const CLIENT_ID    = "532950765171-rfh9ide8056k8sstf06qhcm96iv92s22.apps.googleusercontent.com";
const REDIRECT_URI = "https://my-recorder.vercel.app";
const SCOPE        = "https://www.googleapis.com/auth/drive";

/* GLOBALS */
let accessToken = null, mediaRecorder = null, recordedChunks = [], currentStream = null;

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function authenticate() {
  const url = "https://accounts.google.com/o/oauth2/v2/auth?" +
    "client_id="   + CLIENT_ID +
    "&redirect_uri="+ encodeURIComponent(REDIRECT_URI) +
    "&response_type=token" +
    "&scope="      + encodeURIComponent(SCOPE) +
    "&prompt=consent";
  window.location = url;
}

window.onload = () => {
  const p = new URLSearchParams(location.hash.slice(1));
  if (p.has("access_token")) {
    accessToken = p.get("access_token");
    document.getElementById("authStatus").textContent = "âœ… eingeloggt";
    populateFolders();
  }
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ORDNER â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function populateFolders() {
  if (!accessToken) return;
  const select = document.getElementById("folderSelect");
  select.innerHTML = "";
  document.getElementById("folderHint").textContent = "";

  const query = "mimeType='application/vnd.google-apps.folder' and trashed=false";
  const res   = await gapi(
    "https://www.googleapis.com/drive/v3/files" +
    "?fields=files(id,name)" +
    "&orderBy=name" +
    "&q=" + encodeURIComponent(query)
  );

  if (res.error) {
    document.getElementById("folderHint").textContent =
      "âŒ " + (res.error.message || "Fehler beim Laden der Ordner.");
    return;
  }
  if (!res.files.length) {
    document.getElementById("folderHint").textContent =
      "âš ï¸ Keine Ordner gefunden â€“ erstelle einen neuen.";
    return;
  }
  res.files.forEach(f=>{
    const o=document.createElement("option");
    o.value=f.id; o.textContent=f.name; select.appendChild(o);
  });
  loadFolderFiles();
}

async function createFolder() {
  if (!accessToken) return alert("Bitte zuerst einloggen.");
  const name = prompt("Ordnername?");
  if (!name) return;
  await fetch("https://www.googleapis.com/drive/v3/files",{
    method:"POST",
    headers:{ Authorization:"Bearer "+accessToken,"Content-Type":"application/json" },
    body:JSON.stringify({ name, mimeType:"application/vnd.google-apps.folder" })
  });
  populateFolders();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ DATEIEN LISTEN â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadFolderFiles() {
  const folderId = document.getElementById("folderSelect").value;
  if (!folderId) return;
  const q = `'${folderId}' in parents and trashed=false and (mimeType contains 'video/' or name contains '.webm')`;
  const res = await gapi(
    "https://www.googleapis.com/drive/v3/files" +
    "?fields=files(id,name,modifiedTime)" +
    "&orderBy=modifiedTime desc" +
    "&q=" + encodeURIComponent(q)
  );
  const ul = document.getElementById("fileList");
  ul.innerHTML = "";
  res.files.forEach(f=>{
    const li=document.createElement("li");
    const a = document.createElement("a");
    a.href=`https://drive.google.com/file/d/${f.id}/view`;
    a.target="_blank";
    a.textContent=`${new Date(f.modifiedTime).toLocaleString()} â€“ ${f.name}`;
    li.appendChild(a); ul.appendChild(li);
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ AUFNAHME â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function startRecording() {
  try{
    currentStream = await navigator.mediaDevices.getDisplayMedia({video:true,audio:true});
    const vid = document.getElementById("preview");
    vid.srcObject = currentStream; vid.style.display="block";

    recordedChunks=[]; mediaRecorder=new MediaRecorder(currentStream);
    mediaRecorder.ondataavailable=e=>e.data.size&&recordedChunks.push(e.data);
    mediaRecorder.onstop=handleStop; mediaRecorder.start();
    currentStream.getVideoTracks()[0].onended=stopRecording;
    toggleRecButtons(true);
  }catch(e){ alert("Freigabe fehlgeschlagen: "+e); }
}

function stopRecording(){
  if(mediaRecorder&&mediaRecorder.state!=="inactive") mediaRecorder.stop();
  if(currentStream) currentStream.getTracks().forEach(t=>t.stop());
  toggleRecButtons(false);
}

async function handleStop(){
  const blob=new Blob(recordedChunks,{type:"video/webm"});
  const vid=document.getElementById("preview");
  vid.srcObject=null; vid.src=URL.createObjectURL(blob);
  await uploadToDrive(blob);
}

function toggleRecButtons(rec){
  document.querySelector("button[onclick='startRecording()']").disabled=rec;
  document.querySelector("button[onclick='stopRecording()']").disabled=!rec;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function uploadToDrive(blob){
  if(!accessToken) return alert("Bitte einloggen!");
  const folderId=document.getElementById("folderSelect").value;
  const metadata={name:"Recording_"+new Date().toISOString()+".webm",mimeType:"video/webm",parents:[folderId]};
  const form=new FormData();
  form.append("metadata",new Blob([JSON.stringify(metadata)],{type:"application/json"}));
  form.append("file",blob);

  document.getElementById("output").textContent="ğŸ’¾ Hochladen â€¦";
  const up=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",
      {method:"POST",headers:{Authorization:"Bearer "+accessToken},body:form});
  const file=await up.json();

  await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}/permissions`,{
    method:"POST",
    headers:{Authorization:"Bearer "+accessToken,"Content-Type":"application/json"},
    body:JSON.stringify({role:"reader",type:"anyone"})
  });
  const link=`https://drive.google.com/file/d/${file.id}/view`;
  document.getElementById("output").innerHTML=`âœ… Hochgeladen:<br><a href="${link}" target="_blank">${link}</a>`;
  loadFolderFiles();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function gapi(url){
  const r=await fetch(url,{headers:{Authorization:"Bearer "+accessToken}});
  return r.json();
}
</script>
</body>
</html>
