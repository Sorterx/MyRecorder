<!DOCTYPE html>
<html>
<head>
  <title>My Recorder ‚Äì Google Drive Upload</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    button, select { margin:.25rem 0; }
    video { width:80%; margin-top:1rem; display:none; }
    ul { list-style:none; padding-left:0; }
    li { margin:.25rem 0; }
    #folderHint { color:red; }
  </style>
</head>
<body>
  <h2>My Recorder</h2>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <button onclick="authenticate()">üîê Login mit Google</button>
  <span id="authStatus"></span>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ORDNERWAHL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <h3>Aufnahme-Ordner w√§hlen</h3>
  <select id="folderSelect"></select>
  <button onclick="populateFolders()">üîÑ Ordner neu laden</button>
  <button onclick="createFolder()">‚ûï Neuen Ordner anlegen</button>
  <p id="folderHint"></p>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ DATEIEN LISTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <h3>Aufzeichnungen im Ordner</h3>
  <ul id="fileList"></ul>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ AUFNAHME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <h3>Aufnahme</h3>
  <button onclick="startRecording()">‚è∫Ô∏è Start Recording</button>
  <button onclick="stopRecording()" disabled>‚èπÔ∏è Stop Recording</button>

  <video id="preview" controls muted></video>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <pre id="output"></pre>

<script>
/* ===================== CONFIG ===================== */
const CLIENT_ID   = "532950765171-rfh9ide8056k8sstf06qhcm96iv92s22.apps.googleusercontent.com";
const REDIRECT_URI= "https://my-recorder.vercel.app";
const SCOPE       = "https://www.googleapis.com/auth/drive";

/* ===================== GLOBALS ===================== */
let accessToken   = null;
let mediaRecorder = null;
let recordedChunks= [];
let currentStream = null;

/* ===================== AUTH ===================== */
function authenticate() {
  const url =
    "https://accounts.google.com/o/oauth2/v2/auth?" +
    "client_id="   + CLIENT_ID +
    "&redirect_uri="+ encodeURIComponent(REDIRECT_URI) +
    "&response_type=token" +
    "&scope="      + encodeURIComponent(SCOPE) +
    "&prompt=consent";
  window.location = url;
}

window.onload = () => {
  const params = new URLSearchParams(window.location.hash.slice(1));
  if (params.has("access_token")) {
    accessToken = params.get("access_token");
    document.getElementById("authStatus").textContent = "‚úÖ eingeloggt";
    populateFolders();
  }
};

/* ===================== ORDNERHANDLING ===================== */
async function populateFolders() {
  if (!accessToken) return;
  const select = document.getElementById("folderSelect");
  select.innerHTML = "";
  document.getElementById("folderHint").textContent = "";
  try {
    const res = await gapi(
      "https://www.googleapis.com/drive/v3/files" +
      "?q=mimeType='application/vnd.google-apps.folder' and trashed=false" +
      "&fields=files(id,name)&orderBy=name"
    );
    if (!res.files.length) {
      document.getElementById("folderHint").textContent =
        "‚ö†Ô∏è Keine Ordner gefunden ‚Äì erstelle einen neuen.";
      return;
    }
    res.files.forEach(f => {
      const opt = document.createElement("option");
      opt.value = f.id; opt.textContent = f.name;
      select.appendChild(opt);
    });
    loadFolderFiles();
  } catch (e) {
    document.getElementById("folderHint").textContent =
      "‚ùå Fehler beim Laden der Ordner (Pr√ºfe OAuth-Scope).";
  }
}

async function createFolder() {
  if (!accessToken) return alert("Bitte zuerst einloggen.");
  const name = prompt("Ordnername?");
  if (!name) return;
  await fetch("https://www.googleapis.com/drive/v3/files", {
    method : "POST",
    headers: {
      Authorization  : "Bearer " + accessToken,
      "Content-Type" : "application/json"
    },
    body: JSON.stringify({
      name     : name,
      mimeType : "application/vnd.google-apps.folder"
    })
  });
  populateFolders();
}

/* ===================== DATEIEN LISTEN ===================== */
async function loadFolderFiles() {
  const folderId = document.getElementById("folderSelect").value;
  if (!folderId) return;
  const q = `'${folderId}' in parents and trashed=false and (mimeType contains 'video/' or name contains '.webm')`;
  const res = await gapi(
    "https://www.googleapis.com/drive/v3/files" +
    "?fields=files(id,name,modifiedTime)" +
    "&orderBy=modifiedTime desc" +
    "&q=" + encodeURIComponent(q)
  );
  const ul = document.getElementById("fileList");
  ul.innerHTML = "";
  res.files.forEach(f => {
    const li   = document.createElement("li");
    const link = document.createElement("a");
    link.href        = `https://drive.google.com/file/d/${f.id}/view`;
    link.target      = "_blank";
    link.textContent = `${new Date(f.modifiedTime).toLocaleString()} ‚Äì ${f.name}`;
    li.appendChild(link);
    ul.appendChild(li);
  });
}

/* ===================== AUFNAHME ===================== */
async function startRecording() {
  try {
    currentStream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:true });
    document.getElementById("preview").srcObject = currentStream;
    document.getElementById("preview").style.display = "block";

    recordedChunks = [];
    mediaRecorder  = new MediaRecorder(currentStream);
    mediaRecorder.ondataavailable = e => e.data.size && recordedChunks.push(e.data);
    mediaRecorder.onstop = handleStop;
    mediaRecorder.start();

    currentStream.getVideoTracks()[0].onended = stopRecording;
    toggleRecButtons(true);
  } catch (e) {
    alert("Freigabe fehlgeschlagen: " + e);
  }
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
  if (currentStream) currentStream.getTracks().forEach(t => t.stop());
  toggleRecButtons(false);
}

async function handleStop() {
  const blob = new Blob(recordedChunks, { type:"video/webm" });
  document.getElementById("preview").srcObject = null;
  document.getElementById("preview").src = URL.createObjectURL(blob); // manuelles Abspielen
  await uploadToDrive(blob);
}

function toggleRecButtons(rec) {
  document.querySelector("button[onclick='startRecording()']").disabled = rec;
  document.querySelector("button[onclick='stopRecording()']").disabled  = !rec;
}

/* ===================== UPLOAD ===================== */
async function uploadToDrive(blob) {
  if (!accessToken) return alert("Bitte einloggen!");

  const folderId = document.getElementById("folderSelect").value;
  const metadata = {
    name    : "Recording_" + new Date().toISOString() + ".webm",
    mimeType: "video/webm",
    parents : folderId ? [folderId] : []
  };

  const form = new FormData();
  form.append("metadata", new Blob([JSON.stringify(metadata)], { type:"application/json" }));
  form.append("file",     blob);

  document.getElementById("output").textContent = "üíæ Hochladen ‚Ä¶";
  const up = await fetch(
    "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",
    { method:"POST", headers:{ Authorization:"Bearer "+accessToken }, body:form }
  );
  const file = await up.json();

  await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}/permissions`,{
    method : "POST",
    headers: {
      Authorization  : "Bearer " + accessToken,
      "Content-Type" : "application/json"
    },
    body: JSON.stringify({ role:"reader", type:"anyone" })
  });

  const link = `https://drive.google.com/file/d/${file.id}/view`;
  document.getElementById("output").innerHTML =
    `‚úÖ Hochgeladen:<br><a href="${link}" target="_blank">${link}</a>`;
  loadFolderFiles(); // Liste aktualisieren
}

/* ===================== HELPER ===================== */
async function gapi(url) {
  const r = await fetch(url, { headers:{ Authorization:"Bearer "+accessToken } });
  return r.json();
}
</script>
</body>
</html>
