<!DOCTYPE html>
<html>
<head>
  <title>My Recorder ‚Äì Google Drive Uploader</title>
  <meta charset="utf-8">
  <style>
    :root{--bg:#121212;--surface:#1e1e1e;--surface-2:#262626;--primary:#4f8cff;--primary-h:#3d6fd6;--danger:#e04f4f;--font:#e0e0e0;--font-soft:#b0b0b0;--radius:8px;}
    *{box-sizing:border-box}
    body{margin:0;padding:0 2rem 4rem;background:var(--bg);color:var(--font);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    h2{margin:2.5rem 0 1rem;font-weight:600}
    h3{margin:2rem 0 .8rem;color:var(--font-soft);font-weight:500}
    button,select{padding:.5rem 1rem;border:none;border-radius:var(--radius);font-size:.9rem;font-weight:600;cursor:pointer;background:var(--surface-2);color:var(--font);transition:.15s}
    button:hover{background:var(--surface)}
    button.primary{background:var(--primary);color:#fff}
    button.primary:hover{background:var(--primary-h)}
    select{appearance:none;background:var(--surface-2)}
    details{background:var(--surface);border-radius:var(--radius);padding:.5rem 1rem;margin-top:1rem}
    summary{cursor:pointer;outline:none}
    ul{list-style:none;padding:0;margin:0}
    li{display:flex;align-items:center;gap:.6rem;margin:.4rem 0}
    video{width:100%;max-width:800px;border-radius:var(--radius);box-shadow:0 0 12px #000a;margin-top:1rem;display:none;background:#000}
    .del{cursor:pointer;font-weight:700;color:var(--danger);transition:.15s;user-select:none}
    .del:hover{transform:scale(1.15)}
    #status{min-width:220px;text-align:center;font-weight:600}
    a{color:var(--primary);text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:900px;margin:auto}
    .row{display:flex;align-items:center;gap:1rem;flex-wrap:wrap}
    label{display:flex;align-items:center;gap:.4rem;font-size:.85rem;color:var(--font-soft)}
    input[type=checkbox]{accent-color:var(--primary);width:1rem;height:1rem}
  </style>
</head>
<body>
<div class="container">
  <h2>My Recorder</h2>

  <!-- AUTH -->
  <button class="primary" onclick="authenticate()">üîê Login mit Google</button>
  <span id="authStatus"></span>

  <!-- ORDNER -->
  <h3>Aufnahme-Ordner</h3>
  <select id="folderSelect"></select>
  <button onclick="populateFolders()">üîÑ</button>
  <button onclick="createFolder()">‚ûï</button>
  <p id="folderHint"></p>

  <!-- DATEIEN -->
  <details id="fileSection"><summary id="fileSummary">Aufzeichnungen</summary><ul id="fileList"></ul></details>

  <!-- AUFNAHME -->
  <h3>Aufnahme</h3>
  <div class="row">
      <button class="primary" onclick="startRecording()">‚è∫Ô∏è Start</button>
      <button onclick="stopRecording()" disabled>‚èπÔ∏è Stop</button>
      <label><input type="checkbox" id="micToggle" checked> üé§ Mikrofon aufnehmen</label>
      <div id="status"></div>
  </div>
  <video id="preview" controls playsinline></video>
</div>

<script>
const CLIENT_ID="532950765171-rfh9ide8056k8sstf06qhcm96iv92s22.apps.googleusercontent.com";
const REDIRECT_URI="https://my-recorder.vercel.app";
const SCOPE="https://www.googleapis.com/auth/drive";

let accessToken=null,
    mediaRecorder=null,
    recordedChunks=[],
    displayStream=null,
    micStream=null,
    audioCtx=null;

function authenticate(){
  location.href=`https://accounts.google.com/o/oauth2/v2/auth?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${encodeURIComponent(SCOPE)}&prompt=consent`;
}
window.onload=()=>{const p=new URLSearchParams(location.hash.slice(1));if(p.has("access_token")){accessToken=p.get("access_token");document.getElementById("authStatus").textContent="‚úÖ eingeloggt";populateFolders();}};

/* ---------- ORDNER / LISTE / DELETE (unver√§ndert) ---------- */
async function populateFolders(){/* ... unver√§ndert ... */}
async function createFolder(){/* ... unver√§ndert ... */}
async function loadFolderFiles(){/* ... unver√§ndert ... */}
async function deleteFile(id,n){/* ... unver√§ndert ... */}

/* ---------- AUFNAHME ---------- */
async function startRecording(){
  try{
    displayStream=await navigator.mediaDevices.getDisplayMedia({video:true,audio:true});
    const wantMic=document.getElementById("micToggle").checked;
    if(wantMic){
      try{micStream=await navigator.mediaDevices.getUserMedia({audio:true});}
      catch(e){alert("Mikrofon verweigert ‚Äì Aufnahme l√§uft ohne Mikro.");micStream=null;}
    }

    /* Audio-Mix √ºber Web Audio API */
    audioCtx=new AudioContext();
    const dest=audioCtx.createMediaStreamDestination();
    if(displayStream.getAudioTracks().length){
      const dispSource=audioCtx.createMediaStreamSource(new MediaStream(displayStream.getAudioTracks()));
      dispSource.connect(dest);
    }
    if(micStream){
      const micSource=audioCtx.createMediaStreamSource(micStream);
      micSource.connect(dest);
    }

    /* Kombiniere Video + gemischtes Audio */
    const tracks=[...displayStream.getVideoTracks(),...dest.stream.getAudioTracks()];
    const mixedStream=new MediaStream(tracks);

    const v=document.getElementById("preview");
    v.srcObject=mixedStream;v.muted=true;v.style.display="block";await v.play();

    recordedChunks=[];
    mediaRecorder=new MediaRecorder(mixedStream,{mimeType:"video/webm;codecs=vp8"});
    mediaRecorder.ondataavailable=e=>e.data.size&&recordedChunks.push(e.data);
    mediaRecorder.onstop=handleStop;
    mediaRecorder.start();
    displayStream.getVideoTracks()[0].onended=stopRecording;
    toggleRecButtons(true);
  }catch(e){alert("Freigabe fehlgeschlagen: "+e);}
}
function stopRecording(){
  if(mediaRecorder&&mediaRecorder.state!=="inactive")mediaRecorder.stop();
  if(displayStream)displayStream.getTracks().forEach(t=>t.stop());
  if(micStream)micStream.getTracks().forEach(t=>t.stop());
  if(audioCtx){audioCtx.close();audioCtx=null;}
  toggleRecButtons(false);
  micStream=null;displayStream=null;
}
async function handleStop(){
  const blob=new Blob(recordedChunks,{type:"video/webm"});
  const v=document.getElementById("preview");v.srcObject=null;v.src=URL.createObjectURL(blob);
  const name=(prompt("Dateiname (optional):")||"").trim().replace(/\.webm$/i,"")||"Recording_"+new Date().toISOString();
  uploadToDrive(blob,`${name}.webm`);
}
function toggleRecButtons(r){document.querySelector("button[onclick='startRecording()']").disabled=r;document.querySelector("button[onclick='stopRecording()']").disabled=!r;}

/* ---------- UPLOAD + WAIT ---------- */
async function uploadToDrive(blob,name){
  if(!accessToken)return alert("Bitte einloggen!");
  const folder=document.getElementById("folderSelect").value;
  const meta={name,mimeType:"video/webm",parents:[folder]};
  const form=new FormData();
  form.append("metadata",new Blob([JSON.stringify(meta)],{type:"application/json"}));
  form.append("file",blob);

  setStatus("‚è≥ Upload l√§uft ‚Ä¶");
  const r=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:{Authorization:"Bearer "+accessToken},body:form});
  const f=await r.json();
  await fetch(`https://www.googleapis.com/drive/v3/files/${f.id}/permissions`,{method:"POST",headers:{Authorization:"Bearer "+accessToken,"Content-Type":"application/json"},body:JSON.stringify({role:"reader",type:"anyone"})});

  /* Poll bis Drive fertig transkodiert */
  const download=`https://www.googleapis.com/drive/v3/files/${f.id}?alt=media&access_token=${accessToken}`;
  setStatus(`‚åõ Wird verarbeitet ‚Ä¶ <br><a href="${download}" target="_blank">Original herunterladen</a>`);
  await waitUntilReady(f.id,name);
  loadFolderFiles();
}
async function waitUntilReady(id,name){
  let ready=false;
  while(!ready){
    await new Promise(r=>setTimeout(r,5000));
    const meta=await gapi(`https://www.googleapis.com/drive/v3/files/${id}?fields=videoMediaMetadata`);
    ready=!!meta.videoMediaMetadata;
  }
  setStatus(`‚úÖ <a href="https://drive.google.com/file/d/${id}/view" target="_blank">${name}</a>`);
}
function setStatus(h){document.getElementById("status").innerHTML=h;}

/* ---------- HELPER ---------- */
async function gapi(url){return(await fetch(url,{headers:{Authorization:"Bearer "+accessToken}})).json();}
</script>
</body>
</html>
