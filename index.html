<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>MyRecorder</title>

  <!-- Let the browser know we want to capture the screen on this origin -->
  <meta http-equiv="Permissions-Policy" content="display-capture=(self)">

  <style>
    :root {
      --bg: #121212;
      --surface: #1e1e1e;
      --surface-2: #262626;
      --primary: #4f8cff;
      --primary-h: #3d6fd6;
      --danger: #e04f4f;
      --font: #e0e0e0;
      --font-soft: #b0b0b0;
      --radius: 8px;
      --logo-top: 40px;
      --logo-left: 40px;
      --logo-h: 210px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    body {
      background: var(--bg);
      color: var(--font);
      font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      padding: 0 2rem 4rem
    }

    /* ‚îÄ‚îÄ‚îÄ layout ‚îÄ‚îÄ‚îÄ */
    .logo {
      position: fixed;
      top: var(--logo-top);
      left: var(--logo-left);
      height: var(--logo-h);
      user-select: none;
      z-index: 1000;
    }

    @media(max-width:600px) {
      .logo {
        height: 90px
      }
    }

    .authBox {
      position: fixed;
      top: 24px;
      right: 24px;
      display: flex;
      align-items: center;
      gap: .8rem;
      z-index: 1000;
    }

    .authBox span {
      font-weight: 600
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding-top: calc(140px + var(--logo-top) + 40px);
    }

    h3 {
      margin: 2rem 0 .8rem;
      color: var(--font-soft);
      font-weight: 500
    }

    /* ‚îÄ‚îÄ‚îÄ controls ‚îÄ‚îÄ‚îÄ */
    button,
    select {
      padding: .5rem 1rem;
      border: 1px solid var(--surface-2);
      border-radius: var(--radius);
      font-size: .9rem;
      font-weight: 500;
      cursor: pointer;
      background: transparent;
      color: var(--font);
      transition: all .2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .5rem;
    }

    button:hover,
    select:hover {
      background: var(--surface-2);
      border-color: var(--surface-2);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button.primary {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }

    button.primary:hover {
      background: var(--primary-h);
      border-color: var(--primary-h);
    }

    select {
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23b0b0b0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right .7rem center;
      background-size: 1em;
      padding-right: 2.5rem;
    }

    details {
      background: var(--surface);
      border-radius: var(--radius);
      padding: .5rem 1rem;
      margin-top: 1rem
    }

    summary {
      cursor: pointer
    }

    ul {
      list-style: none
    }

    li {
      display: flex;
      align-items: center;
      gap: .6rem;
      margin: .4rem 0
    }

    .del {
      cursor: pointer;
      font-weight: 700;
      color: var(--danger);
      transition: transform .15s;
      display: inline-flex;
      align-items: center;
    }

    .del:hover {
      transform: scale(1.2)
    }

    /* ‚îÄ‚îÄ‚îÄ preview & status ‚îÄ‚îÄ‚îÄ */
    video {
      width: 100%;
      max-width: 100%;
      border-radius: var(--radius);
      box-shadow: 0 0 12px #000a;
      margin-top: 1rem;
      background: #000;
      display: none
    }

    #status {
      min-width: 220px;
      text-align: center;
      font-weight: 600;
      margin-top: .5rem;
      min-height: 1.5em
    }

    #progressBar {
      width: 100%;
      height: 8px;
      background: #333;
      border-radius: var(--radius);
      overflow: hidden;
      margin-top: .3rem
    }

    #progressFill {
      width: 0%;
      height: 100%;
      background: var(--primary);
      transition: width .2s
    }

    .timer {
      font-family: monospace;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary);
      min-width: 60px;
      text-align: center
    }

    a {
      color: var(--primary);
      text-decoration: none
    }

    a:hover {
      text-decoration: underline
    }

    .row {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap
    }

    label {
      display: flex;
      align-items: center;
      gap: .4rem;
      font-size: .85rem;
      color: var(--font-soft);
      cursor: pointer
    }

    input[type=checkbox] {
      accent-color: var(--primary);
      width: 1rem;
      height: 1rem
    }

    #mobileHint {
      margin-top: .75rem;
      font-size: .85rem;
      color: #f5d97a
    }

    /* List improvements */
    li {
      background: var(--surface-2);
      padding: .5rem;
      border-radius: var(--radius);
      margin-bottom: .5rem
    }

    li:hover {
      background: var(--surface)
    }

    li a {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap
    }
  </style>
</head>

<body>

  <img src="myrecorderlogo.png?v=11" alt="My Recorder Logo" class="logo">

  <!-- Login -->
  <div class="authBox">
    <button id="loginBtn" class="primary" onclick="authenticate()">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect width="18" height="11" x="3" y="11" rx="2" ry="2" />
        <path d="M7 11V7a5 5 0 0 1 10 0v4" />
      </svg>
      Login
    </button>
    <button id="logoutBtn" onclick="logout()" style="display:none">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
        <polyline points="16 17 21 12 16 7" />
        <line x1="21" x2="9" y1="12" y2="12" />
      </svg>
      Logout
    </button>
    <span id="authStatus"></span>
  </div>

  <div class="container">

    <!-- Ordner -->
    <h3>Aufnahme-Ordner</h3>
    <select id="folderSelect"></select>
    <button onclick="populateFolders()" title="Refresh Folders">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
        <path d="M21 3v5h-5" />
        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
        <path d="M3 21v-5h5" />
      </svg>
    </button>
    <button onclick="createFolder()" title="New Folder">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M5 12h14" />
        <path d="M12 5v14" />
      </svg>
    </button>
    <p id="folderHint"></p>

    <!-- Dateien -->
    <details>
      <circle cx="12" cy="12" r="3" fill="currentColor" />
      </svg>
      Start
      </button>
      <button onclick="stopRecording()" disabled>
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect width="18" height="18" x="3" y="3" rx="2" ry="2" />
          <rect width="8" height="8" x="8" y="8" fill="currentColor" />
        </svg>
        Stop
      </button>
      <span id="timer" class="timer">00:00</span>
      <label>
        <input type="checkbox" id="micToggle" checked>
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" let accessToken,
          mediaRecorder, recordedChunks=[]; let displayStream, micStream, audioCtx; let timerInterval, startTime; /* ‚îÄ‚îÄ‚îÄ
          FEATURE CHECK ‚îÄ‚îÄ‚îÄ */ const hasCapture=!!(navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia);
          const isAndroid=/android/i.test(navigator.userAgent); const
          flagMsg="‚ö†Ô∏è Screen-capture is still experimental in this Chrome build.\n"
          + "Open chrome://flags and enable ‚ÄúExperimental Web Platform Features‚Äù, then restart the browser." ; if
          (!hasCapture) { // Button is already disabled by default
          document.getElementById("mobileHint").textContent="‚ö†Ô∏è Dieser Browser unterst√ºtzt keine Screen-Capture-API. "
          + "Nutze den System-Recorder und lade die Datei manuell hoch." ; } else if (isAndroid) {
          document.getElementById("mobileHint").textContent=flagMsg; } /* ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ */ function authenticate() {
          location.href=`https://accounts.google.com/o/oauth2/v2/auth?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT)}&response_type=token&scope=${encodeURIComponent(SCOPE)}&prompt=consent`;
          } function logout() { localStorage.removeItem("accessToken"); accessToken=null; location.hash="" ;
          location.reload(); } window.onload=()=> {
          const p = new URLSearchParams(location.hash.slice(1));
          if (p.has("access_token")) {
          accessToken = p.get("access_token");
          localStorage.setItem("accessToken", accessToken);
          location.hash = ""; // Clean URL
          } else {
          accessToken = localStorage.getItem("accessToken");
          }

          if (accessToken) {
          document.getElementById("authStatus").textContent = "‚úÖ eingeloggt";
          document.getElementById("loginBtn").style.display = "none";
          document.getElementById("logoutBtn").style.display = "block";
          document.getElementById("preview").style.display = "block";
          if (hasCapture) document.getElementById("startBtn").disabled = false; // Enable start button
          populateFolders();
          }
          };

          /* ‚îÄ‚îÄ‚îÄ HELPER ‚îÄ‚îÄ‚îÄ */
          const gapi = async url => (await fetch(url, { headers: { Authorization: `Bearer ${accessToken}` } })).json();

          /* ‚îÄ‚îÄ‚îÄ ORDNER & DATEIEN ‚îÄ‚îÄ‚îÄ */
          async function populateFolders() {
          if (!accessToken) return;
          const sel = document.getElementById("folderSelect"); sel.innerHTML = "";
          const res = await gapi("https://www.googleapis.com/drive/v3/files?fields=files(id,name)&orderBy=name&q=" +
          encodeURIComponent("mimeType='application/vnd.google-apps.folder' and trashed=false"));
          res.files?.forEach(f => { const o = document.createElement("option"); o.value = f.id; o.textContent = f.name;
          sel.appendChild(o); });
          loadFolderFiles();
          }
          async function createFolder() {
          const n = prompt("Ordnername?"); if (!n) return;
          await fetch("https://www.googleapis.com/drive/v3/files", { method: "POST", headers: { Authorization: `Bearer
          ${accessToken}`, "Content-Type": "application/json" }, body: JSON.stringify({ name: n, mimeType:
          "application/vnd.google-apps.folder" }) });
          populateFolders();
          }
          async function loadFolderFiles() {
          const id = document.getElementById("folderSelect").value; if (!id) return;
          const q = `'${id}' in parents and trashed=false and (mimeType contains 'video/' or name contains '.webm')`;
          const res = await
          gapi("https://www.googleapis.com/drive/v3/files?fields=files(id,name,modifiedTime)&orderBy=modifiedTime
          desc&q=" + encodeURIComponent(q));
          const ul = document.getElementById("fileList"); ul.innerHTML = "";
          res.files?.forEach(f => {
          const li = document.createElement("li");
          const del = document.createElement("span");
          del.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6 6 18" />
            <path d="m6 6 12 12" />
          </svg>`;
          del.className = "del"; del.onclick = _ => deleteFile(f.id, f.name);
          const a = document.createElement("a"); a.href = `https://drive.google.com/file/d/${f.id}/view`; a.target =
          "_blank";
          a.textContent = `${new Date(f.modifiedTime).toLocaleString()} ‚Äì ${f.name}`;
          li.append(del, a); ul.append(li);
          });
          document.getElementById("fileSummary").textContent = `Aufzeichnungen (${res.files?.length || 0})`;
          }
          async function deleteFile(id, n) {
          if (!confirm(`"${n}" l√∂schen?`)) return; setStatus("‚è≥ L√∂schen ‚Ä¶");
          }
          async function handleStop() {
          const blob = new Blob(recordedChunks, { type: "video/webm" });
          const vid = document.getElementById("preview"); vid.srcObject = null; vid.src = URL.createObjectURL(blob);
          const base = (prompt("Dateiname (optional):") || "").trim().replace(/\.webm$/i, "") || "Recording_" + new
          Date().toISOString();
          upload(blob, `${base}.webm`);
          xhr.send(body);
          }

          async function pollProcessing(id, name, max) {
          for (let i = 0; i < max; i++) { const meta=await
            gapi(`https://www.googleapis.com/drive/v3/files/${id}?fields=videoMediaMetadata`); if
            (meta.videoMediaMetadata) { setStatus(`‚úÖ <a href="https://drive.google.com/file/d/${id}/view"
            target="_blank">${name}</a>`); return;
            }
            await new Promise(r => setTimeout(r, 5000));
            }
            setStatus(`üü° <a href="https://drive.google.com/file/d/${id}/view"
              target="_blank">${name}</a><br><small>Video wird evtl. noch verarbeitet</small>`);
            }

            function setStatus(html) { document.getElementById("status").innerHTML = html; }

            /* ‚îÄ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ‚îÄ */
            function startTimer() {
            startTime = Date.now();
            document.getElementById("timer").textContent = "00:00";
            timerInterval = setInterval(() => {
            const diff = Math.floor((Date.now() - startTime) / 1000);
            const m = Math.floor(diff / 60).toString().padStart(2, "0");
            const s = (diff % 60).toString().padStart(2, "0");
            document.getElementById("timer").textContent = `${m}:${s}`;
            }, 1000);
            }
            function stopTimer() { clearInterval(timerInterval); }
            </script>

            <footer style="margin-top:3rem;text-align:center;font-size:.75rem;color:var(--font-soft)">
              <p><a href="/terms.html" target="_blank" style="color:var(--font-soft);text-decoration:none">Terms of
                  Service</a> ¬∑
                <a href="/privacy.html" target="_blank" style="color:var(--font-soft);text-decoration:none">Privacy
                  Policy</a>
              </p>
            </footer>
</body>

</html>